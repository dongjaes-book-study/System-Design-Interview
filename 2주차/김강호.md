# 5장 안정해시설계

### 안정 해시
- 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술

### 해시 링
- 안정 해시를 링의 형태로 표현한 것
- 어떤 키가 저장되는 서버는, 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 키이이다.
- 이 방법을 사용하면 서버를 추가/삭제 할 경우 일부 서버만 재배치가 이루어진다.

### 단순 해시 링의 문제점
1. 서버가 추가되거나 사제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는 게 불가능하다.
2. 키의 균등 분포를 달성하긱가 어렵다

### 단순 해시 링의 개선
- 가상 노드 사용
- 가상 노드의 개수를 늘리면 표준 편차의 값이 떨어지며 저장할 공간은 더 많이 필요해진다.
- 가상 노드의 개수를 적절하게 선택하는 것이 중요


# 6장 키-값저장소설계

### 단일 서버 키-값 저장소
- 한 대 서버만 사용하는 것은 EZ하다
- 단일 서버 특성상 많은 데이터를 저장하고 있는 것이 불가능할 수 있다

### 분산 키-값 저장소
- 여러 대의 서버에 데이터를 분산하여 저장하는 것

### CAP 정리
- 일관성(Consistency)
- 가용성(Availability)
- 파티션 감내(Partition Tolerance) - 분할 내성이라고도 불림

일관성 : 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 한다.

가용성: 분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다.

파티션 감내 : 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다. 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작하여야 한다는 것을 의미한다.

### 데이터 파티션 고려 사항
- 데이터를 여러 서버에 고르게 분산할 수 있는가?
- 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화할 수 있는가?

### 안정 해시를 이용한 데이터 파티션의 장점
- 규모 확장 자동화 : 시스템 부하에 따라 서버가 자동으로 추가되거나 삭제되도록 만들 수 있다.
- 다양성 : 각 서버의 용량에 맞게 가상 노드의 수를 조정할 수 있다. 다시 말해, 고성능 서버는 더 많은 가상 노드를 갖도록 설정할 수 있다.

### 데이터 다중화
- 높은 가용성과 안정성을 확보하기 위해서는 데이터를 N개 서버에 비동기적으로 다중화할 필요가 있다.

### 데이터 일관성
- 여러 노드에 다중화된 데이터는 적절히 동기화가 되어야 한다.

#### 일관성 모델
- 강한 일관성 : 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환한다. 다시 말해 클라이언트는 절대로 낡은 데이터를 보지 못한다.
- 약한 일광성 : 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다.
- 결과적 일관성 : 약한 일관성의 한 형태로, 갱신 결과가 결국에는 모든 사본에 반영되는 모델

고가용성 시스템에는 강한 일관성은 적합하지 않으며 결과적 일관성 모델을 사용하며 일관성이 깨지는 문제는 클라이언트에서 데이터 버저닝을 사용해 해결하는 방법으로 진행

#### 데이터 버저닝(비 일관성 해소 기법)
- 버저닝과 벡터 시계를 이용
- 데이터를 변경할 때마다 새로운 버전을 만드는 방법

#### 장애 감지
가십 프로토콜 같은 분산형 장애 감지 솔루션을 채택

가십 프로토콜 순서
1. 각 노드는 주기적으로 다른 노드에게 가십 메시지를 보낸다.
2. 가십 메시지를 받은 노드는 자신의 상태를 응답한다.
3. 가십 메시지를 받은 노드는 응답을 받은 노드의 상태를 갱신한다.
4. 응답이 오지 않으면 장애가 발생한 것으로 간주한다.

#### 일시적 장애 처리
- 네트워크나 서버 문제로 장애 상태인 서버로 가는 요청은 다른 서버가 잠시 맡아 처리한다.
- 그동안 발생한 변경사항은 해당 서버가 복구 되었을 때 일괄 반영하여 데이터 일관성을 보존한다
- hint 사용하여 처리


#### 영구적 장애 처리
- 반-엔트로피 프로토콜을 구현하여 사본들을 동기화한다.
- 반-엔트로피 프로토콜은 사본들을 비교하여 최신 버전으로 갱신하는 과정을 포함한다.
- 사본 간의 일관성이 망가진 상태를 탐지하고 전송 데이터의 양을 줄이기 위해 해시 트리를 사용


# 7장 분산시스템을위한유일 ID 생성기설계








# 8장 URL 단축기설계
